<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speech & Reading Coach Pro</title>
    <style>
        :root {
            /* Base Colors */
            --bg-color: #0f0f13;
            --surface-color: #1a1a20;
            --surface-hover: #25252e;
            --text-main: #f0f0f0;
            --text-dim: #888890;
            
            /* Theme Variables (Default: Purple) */
            --primary: #bb86fc;
            --primary-variant: #9955e8;
            --on-primary: #000000;
            
            /* Status Colors */
            --success: #00e676;
            --error: #ff5252;
            --warning: #ffab40;
            
            /* Dimensions */
            --header-height: 60px;
            --radius: 12px;
        }

        [data-theme="blue"] { --primary: #448aff; --primary-variant: #2962ff; }
        [data-theme="green"] { --primary: #69f0ae; --primary-variant: #00c853; }
        [data-theme="orange"] { --primary: #ffab40; --primary-variant: #ff6d00; }
        [data-theme="pink"] { --primary: #ff4081; --primary-variant: #c51162; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: var(--header-height);
            background: rgba(26, 26, 32, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 100;
        }

        .logo {
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        /* --- Main Layout --- */
        main {
            flex: 1;
            position: relative;
            display: flex;
            overflow: hidden;
        }

        /* --- Editor View --- */
        #editor-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1);
        }

        .toolbar {
            display: flex;
            gap: 0.8rem;
            padding-bottom: 1rem;
            overflow-x: auto;
        }

        textarea {
            flex: 1;
            background: var(--surface-color);
            border: 2px solid transparent;
            color: var(--text-main);
            border-radius: var(--radius);
            padding: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }
        textarea:focus { border-color: var(--primary); }
        textarea::placeholder { color: var(--text-dim); }

        /* --- Buttons --- */
        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            transition: transform 0.1s, filter 0.2s;
            background: var(--surface-color);
            color: var(--text-main);
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: var(--on-primary); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-outline { border: 1px solid rgba(255,255,255,0.2); }
        
        /* --- Modes (Coach & RSVP) --- */
        .mode-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color);
            z-index: 50;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1);
        }
        .mode-overlay.active { transform: translateY(0); }

        /* Coach Mode Styles */
        #coach-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            font-size: 2rem;
            line-height: 1.8;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .word {
            display: inline-block;
            margin-right: 0.3em;
            padding: 0.1em 0.2em;
            border-radius: 4px;
            color: var(--text-dim);
            transition: all 0.2s ease;
        }
        .word.active { color: var(--text-main); border-bottom: 3px solid var(--primary); transform: scale(1.05); }
        .word.correct { color: var(--success); opacity: 1; }
        .word.missed { color: var(--error); text-decoration: line-through; opacity: 0.5; }

        /* RSVP Mode Styles */
        #rsvp-display {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: 800;
            text-align: center;
            padding: 1rem;
            color: var(--primary);
        }
        .rsvp-progress {
            height: 4px;
            background: var(--surface-color);
            width: 100%;
            margin-top: auto;
        }
        .rsvp-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* --- Modals & Settings --- */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-backdrop.open { opacity: 1; pointer-events: all; }
        
        .modal {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 { margin-top: 0; color: var(--primary); }
        
        .setting-group { margin-bottom: 1.5rem; }
        .setting-label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .theme-btn {
            height: 40px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .theme-btn.selected { border-color: var(--text-main); }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .stat-box {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .stat-num { display: block; font-size: 2rem; font-weight: 800; color: var(--primary); }
        .stat-lbl { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Library List */
        .lib-item {
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .lib-item:hover { background: rgba(255,255,255,0.08); }
        .lib-title { font-weight: bold; display: block; }
        .lib-desc { font-size: 0.85rem; color: var(--text-dim); }

        /* Range Slider */
        input[type=range] {
            width: 100%;
            accent-color: var(--primary);
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            #coach-content { font-size: 1.5rem; padding: 1rem; }
            #rsvp-display { font-size: 2.5rem; }
            .toolbar { flex-wrap: wrap; }
            .btn { flex: 1; justify-content: center; white-space: nowrap; }
        }

    </style>
</head>
<body>

    <div id="settings-modal" class="modal-backdrop">
        <div class="modal">
            <h2>Settings</h2>
            
            <div class="setting-group">
                <span class="setting-label">Theme Color</span>
                <div class="theme-grid">
                    <button class="theme-btn" style="background:#bb86fc" onclick="setTheme('purple')"></button>
                    <button class="theme-btn" style="background:#448aff" onclick="setTheme('blue')"></button>
                    <button class="theme-btn" style="background:#69f0ae" onclick="setTheme('green')"></button>
                    <button class="theme-btn" style="background:#ffab40" onclick="setTheme('orange')"></button>
                </div>
            </div>

            <div class="setting-group">
                <span class="setting-label">Data Management</span>
                <button class="btn btn-outline" style="width:100%" onclick="resetData()">Reset All History</button>
            </div>
            
            <button class="btn" style="width:100%" onclick="closeModal('settings-modal')">Close</button>
        </div>
    </div>

    <div id="library-modal" class="modal-backdrop">
        <div class="modal">
            <h2>Script Library</h2>
            <p>Select a text to practice with:</p>
            <div id="library-list">
                </div>
            <button class="btn" style="width:100%; margin-top:1rem;" onclick="closeModal('library-modal')">Cancel</button>
        </div>
    </div>

    <div id="results-modal" class="modal-backdrop">
        <div class="modal" style="text-align: center;">
            <h2 id="result-title">Session Complete!</h2>
            <p id="result-msg">Great job improving your skills.</p>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <span class="stat-num" id="res-wpm">0</span>
                    <span class="stat-lbl">WPM</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="res-acc">0%</span>
                    <span class="stat-lbl">Accuracy</span>
                </div>
            </div>

            <div style="display:grid; gap:0.5rem;">
                <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="shareResult()">
                    üîó Share Result
                </button>
                <button class="btn btn-outline" style="width:100%; justify-content:center;" onclick="closeModal('results-modal')">
                    Back to Editor
                </button>
            </div>
        </div>
    </div>

    <header>
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            SpeechCoach Pro
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </div>
    </header>

    <main>
        <section id="editor-view">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="initSpeechMode()">
                    üé§ Speech Mode
                </button>
                <button class="btn btn-outline" onclick="initRSVPMode()">
                    ‚ö° Speed Read
                </button>
                <button class="btn btn-outline" onclick="openLibrary()">
                    üìö Library
                </button>
            </div>
            <textarea id="input-text" placeholder="Type here, paste a script, or choose from the Library..."></textarea>
            <div style="margin-top:0.5rem; font-size:0.8rem; color:var(--text-dim); text-align:right;">
                Pro Tip: Use shorter paragraphs for better speech detection.
            </div>
        </section>

        <section id="coach-mode" class="mode-overlay">
            <header style="background:var(--bg-color);">
                <button class="btn btn-outline" onclick="exitMode('coach')">‚Üê Back</button>
                <div id="speech-status" style="color:var(--primary); font-weight:bold;">Listening...</div>
                <button class="btn btn-primary" onclick="finishSpeechSession()">Finish</button>
            </header>
            <div id="coach-content"></div>
        </section>

        <section id="rsvp-mode" class="mode-overlay">
            <header style="background:var(--bg-color);">
                <button class="btn btn-outline" onclick="exitMode('rsvp')">‚Üê Back</button>
                <div style="display:flex; align-items:center; gap:10px; width:200px;">
                    <span style="font-size:0.8rem;">Speed:</span>
                    <input type="range" id="wpm-slider" min="100" max="1000" step="50" value="300" oninput="updateWPM(this.value)">
                    <span id="wpm-val" style="font-size:0.8rem; min-width:60px;">300</span>
                </div>
            </header>
            <div id="rsvp-display">Ready</div>
            <div class="rsvp-progress"><div class="rsvp-bar" id="rsvp-bar"></div></div>
            <div style="padding: 2rem; display:flex; justify-content:center; gap:1rem;">
                <button id="rsvp-toggle" class="btn btn-primary" onclick="toggleRSVP()">Start</button>
            </div>
        </section>
    </main>

    <script>
        // --- DATA & CONFIG ---
        const libraryTexts = [
            { title: "Famous: Gettysburg Address", desc: "Abraham Lincoln's historic speech.", text: "Four score and seven years ago our fathers brought forth on this continent, a new nation, conceived in Liberty, and dedicated to the proposition that all men are created equal. Now we are engaged in a great civil war, testing whether that nation, or any nation so conceived and so dedicated, can long endure." },
            { title: "Fun: Tongue Twister", desc: "A classic pronunciation challenge.", text: "Peter Piper picked a peck of pickled peppers. A peck of pickled peppers Peter Piper picked. If Peter Piper picked a peck of pickled peppers, where's the peck of pickled peppers Peter Piper picked?" },
            { title: "Motivation: Don't Quit", desc: "Inspirational verses.", text: "When things go wrong as they sometimes will, when the road you're trudging seems all uphill, when the funds are low and the debts are high, and you want to smile but you have to sigh, when care is pressing you down a bit, rest if you must but don't you quit." },
            { title: "Practice: The Solar System", desc: "Scientific reading passage.", text: "The Solar System is the gravitationally bound system of the Sun and the objects that orbit it, either directly or indirectly. Of the objects that orbit the Sun directly, the largest are the eight planets, with the remainder being smaller objects, the dwarf planets and small Solar System bodies." }
        ];

        let state = {
            theme: localStorage.getItem('theme') || 'purple',
            history: JSON.parse(localStorage.getItem('history') || '[]'),
            wpm: 300
        };

        // --- DOM ELEMENTS ---
        const el = {
            input: document.getElementById('input-text'),
            coachMode: document.getElementById('coach-mode'),
            coachContent: document.getElementById('coach-content'),
            rsvpMode: document.getElementById('rsvp-mode'),
            rsvpDisplay: document.getElementById('rsvp-display'),
            rsvpBar: document.getElementById('rsvp-bar'),
            rsvpToggle: document.getElementById('rsvp-toggle'),
            resModal: document.getElementById('results-modal'),
            resWpm: document.getElementById('res-wpm'),
            resAcc: document.getElementById('res-acc'),
            resMsg: document.getElementById('result-msg')
        };

        // --- INIT ---
        setTheme(state.theme);

        // --- CORE FUNCTIONS ---

        function setTheme(color) {
            document.body.setAttribute('data-theme', color);
            localStorage.setItem('theme', color);
            
            // Update UI buttons
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected'));
            // Find button roughly matching color (simplification)
            state.theme = color;
        }

        function openLibrary() {
            const list = document.getElementById('library-list');
            list.innerHTML = libraryTexts.map(t => `
                <div class="lib-item" onclick="loadText('${t.text.replace(/'/g, "\\'")}')">
                    <span class="lib-title">${t.title}</span>
                    <span class="lib-desc">${t.desc}</span>
                </div>
            `).join('');
            openModal('library-modal');
        }

        function loadText(text) {
            el.input.value = text;
            closeModal('library-modal');
        }

        function checkInput() {
            if(!el.input.value.trim()) {
                openLibrary();
                return false;
            }
            return true;
        }

        // --- SPEECH MODE ENGINE ---
        let recognition;
        let speechWords = [];
        let speechIndex = 0;
        let speechCorrect = 0;
        let speechStartTime;
        let isListening = false;

        function initSpeechMode() {
            if(!checkInput()) return;
            
            // Browser Support Check
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRec) {
                alert("Speech API not supported in this browser. Please use Chrome.");
                return;
            }

            // Setup Data
            const text = el.input.value;
            speechWords = text.trim().split(/\s+/);
            el.coachContent.innerHTML = speechWords.map((w,i) => `<span id="w-${i}" class="word">${w}</span>`).join('');
            
            speechIndex = 0;
            speechCorrect = 0;
            
            el.coachMode.classList.add('active');
            highlightWord(0);

            // Setup API
            recognition = new SpeechRec();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                speechStartTime = Date.now();
                document.getElementById('speech-status').innerText = "Listening... (Speak naturally)";
            };

            recognition.onend = () => {
                if(isListening) recognition.start(); // Auto-restart if silence stops it
            };

            recognition.onresult = processSpeech;
            recognition.start();
        }

        function processSpeech(event) {
            // Get last result
            const results = event.results;
            const transcript = results[results.length - 1][0].transcript.toLowerCase().trim();
            const spokenTokens = transcript.split(' ');
            const lastWord = spokenTokens[spokenTokens.length - 1]; // Use last word for matching

            // Fuzzy logic: Check if last spoken word matches current target or next 2 targets
            // This handles if user speaks faster than API updates or skips a word
            const targetClean = clean(speechWords[speechIndex]);
            
            // Attempt Match
            let matchFound = false;
            let jumpIndex = 0;

            for(let i=0; i<3; i++) { // Look ahead 3 words
                if(speechIndex + i >= speechWords.length) break;
                
                const nextTarget = clean(speechWords[speechIndex + i]);
                if(spokenTokens.some(t => t.includes(nextTarget) || nextTarget.includes(t))) {
                    matchFound = true;
                    jumpIndex = i;
                    break;
                }
            }

            if(matchFound) {
                // Mark skipped
                for(let k=0; k<jumpIndex; k++) {
                    markWord(speechIndex + k, 'missed');
                }
                // Mark correct
                markWord(speechIndex + jumpIndex, 'correct');
                speechCorrect++;
                
                // Move pointer
                speechIndex += (jumpIndex + 1);
                
                if(speechIndex < speechWords.length) {
                    highlightWord(speechIndex);
                } else {
                    finishSpeechSession();
                }
            }
        }

        function clean(str) { return str.toLowerCase().replace(/[^\w]/g, ''); }

        function markWord(idx, type) {
            const dom = document.getElementById(`w-${idx}`);
            if(dom) dom.className = `word ${type}`;
        }

        function highlightWord(idx) {
            // Remove old active
            document.querySelectorAll('.word.active').forEach(e => e.classList.remove('active'));
            const dom = document.getElementById(`w-${idx}`);
            if(dom) {
                dom.classList.add('active');
                dom.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function finishSpeechSession() {
            isListening = false;
            if(recognition) recognition.stop();
            el.coachMode.classList.remove('active');

            const timeSec = (Date.now() - speechStartTime) / 1000;
            const wpm = Math.round((speechCorrect / timeSec) * 60) || 0;
            const acc = Math.round((speechCorrect / speechWords.length) * 100) || 0;

            showResults(wpm, acc, "Speech Session");
        }

        // --- RSVP MODE ENGINE ---
        let rsvpInterval;
        let rsvpWords = [];
        let rsvpIndex = 0;
        let rsvpRunning = false;

        function initRSVPMode() {
            if(!checkInput()) return;
            rsvpWords = el.input.value.trim().split(/\s+/);
            rsvpIndex = 0;
            rsvpRunning = false;
            el.rsvpDisplay.innerText = "Press Start";
            el.rsvpToggle.innerText = "Start Reading";
            el.rsvpBar.style.width = "0%";
            el.rsvpMode.classList.add('active');
        }

        function updateWPM(val) {
            state.wpm = val;
            document.getElementById('wpm-val').innerText = val;
            if(rsvpRunning) {
                stopRSVP();
                startRSVP();
            }
        }

        function toggleRSVP() {
            if(rsvpRunning) stopRSVP();
            else startRSVP();
        }

        function startRSVP() {
            rsvpRunning = true;
            el.rsvpToggle.innerText = "Pause";
            el.rsvpToggle.className = "btn btn-outline"; // Visual change
            
            const delay = 60000 / state.wpm;

            rsvpInterval = setInterval(() => {
                if(rsvpIndex >= rsvpWords.length) {
                    finishRSVPSession();
                    return;
                }
                el.rsvpDisplay.innerText = rsvpWords[rsvpIndex];
                
                // Progress Bar
                const pct = ((rsvpIndex + 1) / rsvpWords.length) * 100;
                el.rsvpBar.style.width = `${pct}%`;

                rsvpIndex++;
            }, delay);
        }

        function stopRSVP() {
            rsvpRunning = false;
            clearInterval(rsvpInterval);
            el.rsvpToggle.innerText = "Resume";
            el.rsvpToggle.className = "btn btn-primary";
        }

        function finishRSVPSession() {
            stopRSVP();
            el.rsvpMode.classList.remove('active');
            // RSVP assumes 100% accuracy if finished
            showResults(state.wpm, 100, "Speed Reading");
        }

        // --- RESULTS & UTILS ---
        
        function showResults(wpm, acc, type) {
            el.resWpm.innerText = wpm;
            el.resAcc.innerText = acc + '%';
            
            // Dynamic Message
            let msg = "Practice makes perfect!";
            if(wpm > 400 && acc > 80) msg = "You are a reading machine! üöÄ";
            else if(wpm > 200 && acc > 90) msg = "Great consistency and flow. ‚≠ê";
            else if(acc < 50) msg = "Try slowing down to improve accuracy.";
            
            el.resMsg.innerText = msg;
            
            // Save to History
            state.history.push({ date: new Date().toLocaleString(), type, wpm, acc });
            localStorage.setItem('history', JSON.stringify(state.history));
            
            openModal('results-modal');
        }

        function shareResult() {
            const text = `I just hit ${el.resWpm.innerText} WPM with ${el.resAcc.innerText} accuracy on SpeechCoach Pro! üöÄ`;
            if(navigator.share) {
                navigator.share({ title: 'SpeechCoach Stats', text: text });
            } else {
                navigator.clipboard.writeText(text);
                alert("Stats copied to clipboard!");
            }
        }

        function exitMode(mode) {
            isListening = false;
            if(recognition) recognition.stop();
            stopRSVP();
            
            if(mode === 'coach') el.coachMode.classList.remove('active');
            if(mode === 'rsvp') el.rsvpMode.classList.remove('active');
        }

        function openSettings() { openModal('settings-modal'); }
        
        function resetData() {
            if(confirm("Delete all history?")) {
                localStorage.removeItem('history');
                state.history = [];
                alert("Data reset.");
            }
        }

        // Modal Logic
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        // Close modal on outside click
        window.onclick = function(e) {
            if(e.target.classList.contains('modal-backdrop')) {
                e.target.classList.remove('open');
            }
        }

    </script>
</body>
</html>
