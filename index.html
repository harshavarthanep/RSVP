<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceFlow - Pro Speech Coach</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Default Theme: Cyber Purple */
            --hue: 260;
            --bg: #0f0f13;
            --surface: #1a1a20;
            --surface-2: #25252e;
            --primary: hsl(var(--hue), 80%, 65%);
            --primary-dim: hsl(var(--hue), 40%, 30%);
            --text-main: #ffffff;
            --text-muted: #888899;
            --success: #00e676;
            --danger: #ff5252;
            --radius: 12px;
            --font-display: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* Reset & Base */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: var(--font-display);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease;
        }

        /* --- Layout --- */
        header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 15, 19, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 100;
        }

        .logo { font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .logo i { color: var(--primary); }

        .top-actions { display: flex; gap: 1rem; }
        .icon-btn {
            background: none; border: none; color: var(--text-main);
            font-size: 1.1rem; cursor: pointer; padding: 8px;
            border-radius: 50%; transition: background 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); color: var(--primary); }

        main { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        /* --- Editor Section --- */
        #editor-view {
            flex: 1; display: flex; flex-direction: column; padding: 1rem;
            max-width: 900px; margin: 0 auto; width: 100%;
        }

        .toolbar {
            display: flex; gap: 10px; margin-bottom: 1rem;
            flex-wrap: wrap; justify-content: center;
        }

        .text-area-container {
            flex: 1; position: relative;
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,0.05);
            overflow: hidden;
        }

        textarea {
            width: 100%; height: 100%;
            background: transparent; border: none;
            padding: 1.5rem; color: var(--text-main);
            font-size: 1.1rem; line-height: 1.7;
            resize: none; outline: none;
        }

        .random-btn {
            position: absolute; bottom: 1rem; right: 1rem;
            background: var(--surface-2); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted); padding: 8px 12px;
            border-radius: 20px; font-size: 0.8rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .random-btn:hover { background: var(--primary); color: #000; }

        /* --- Buttons --- */
        .btn {
            border: none; padding: 12px 24px;
            border-radius: 50px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            font-size: 0.95rem; transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary {
            background: var(--primary); color: #000;
            box-shadow: 0 4px 15px var(--primary-dim);
        }
        .btn-outline {
            background: transparent; border: 1px solid var(--primary); color: var(--primary);
        }
        .btn-danger { background: #ff4757; color: white; }

        /* --- Fullscreen Overlays (Modes) --- */
        .mode-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 200;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .mode-overlay.active { transform: translateY(0); }

        /* --- Speech Mode UI --- */
        .teleprompter {
            flex: 1; padding: 2rem; overflow-y: auto;
            font-size: 2rem; line-height: 1.6; text-align: left;
            max-width: 800px; margin: 0 auto; width: 100%;
            scroll-behavior: smooth;
        }
        
        .word {
            display: inline-block; padding: 2px 4px; border-radius: 4px; margin-right: 4px;
            color: var(--text-muted); transition: all 0.2s;
        }
        .word.pending { color: var(--text-muted); }
        .word.active { color: #fff; text-decoration: underline; text-decoration-color: var(--primary); transform: scale(1.05); }
        .word.spoken { color: var(--primary); opacity: 1; }
        .word.missed { color: var(--danger); opacity: 0.5; text-decoration: line-through; }

        /* --- RSVP Mode UI --- */
        .rsvp-container {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; position: relative;
        }
        .rsvp-focus-guide {
            position: absolute; width: 20px; height: 20px;
            border-top: 2px solid var(--danger); border-bottom: 2px solid var(--danger);
            top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.3;
        }
        #rsvp-word-display {
            font-size: 4rem; font-weight: 800; color: var(--text-main);
            text-align: center; z-index: 2;
        }
        .highlight-letter { color: var(--primary); }
        
        .rsvp-controls {
            padding: 2rem; width: 100%; max-width: 600px; margin: 0 auto;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .slider-wrapper { display: flex; align-items: center; gap: 1rem; color: var(--text-muted); }
        input[type=range] { flex: 1; accent-color: var(--primary); }
        
        .progress-bar-container {
            height: 4px; background: var(--surface-2); width: 100%; margin-top: 20px;
        }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }

        /* --- Modals --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 300;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-backdrop.open { opacity: 1; pointer-events: all; }
        
        .modal {
            background: var(--surface); width: 90%; max-width: 400px;
            padding: 2rem; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal h2 { margin-top: 0; color: var(--primary); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
        .stat-box { background: var(--bg); padding: 1rem; border-radius: 8px; }
        .stat-num { display: block; font-size: 1.5rem; font-weight: bold; color: var(--text-main); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* Theme Grid */
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 1rem; }
        .theme-swatch { height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .theme-swatch.selected { border-color: #fff; }

        /* Responsive */
        @media (max-width: 600px) {
            .teleprompter { font-size: 1.5rem; padding: 1rem; }
            #rsvp-word-display { font-size: 2.5rem; }
            .toolbar { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fa-solid fa-microphone-lines"></i> VoiceFlow</div>
        <div class="top-actions">
            <button class="icon-btn" onclick="openSettings()" title="Settings"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main id="main-view">
        <div id="editor-view">
            <div class="text-area-container">
                <textarea id="input-text" placeholder="Paste your text here... or click the dice for a random script."></textarea>
                <button class="random-btn" onclick="insertRandomText()">
                    <i class="fa-solid fa-dice"></i> Random Script
                </button>
            </div>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="initSpeechMode()">
                    <i class="fa-solid fa-microphone"></i> Start Speaking
                </button>
                <button class="btn btn-outline" onclick="initRSVPMode()">
                    <i class="fa-solid fa-bolt"></i> Speed Read
                </button>
            </div>
        </div>
    </main>

    <div id="speech-overlay" class="mode-overlay">
        <header>
            <div class="logo" style="font-size: 1rem;">Thinking: <span id="speech-status" style="color:var(--primary); margin-left:5px;">Listening...</span></div>
            <button class="btn btn-danger" style="padding: 8px 16px; font-size: 0.8rem;" onclick="exitSpeechMode(false)">Stop</button>
        </header>
        <div class="teleprompter" id="teleprompter">
            </div>
    </div>

    <div id="rsvp-overlay" class="mode-overlay">
        <div class="rsvp-container">
            <div class="rsvp-focus-guide"></div>
            <div id="rsvp-word-display">Ready</div>
        </div>
        <div class="progress-bar-container">
            <div id="rsvp-progress" class="progress-bar-fill"></div>
        </div>
        <div class="rsvp-controls">
            <div class="slider-wrapper">
                <i class="fa-solid fa-gauge-high"></i>
                <input type="range" id="wpm-slider" min="150" max="800" step="25" value="300" oninput="updateWPMDisplay(this.value)">
                <span id="wpm-value" style="width: 80px; text-align:right; font-weight:bold;">300 WPM</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" style="flex:1" onclick="exitRSVPMode()">Exit</button>
                <button id="rsvp-toggle-btn" class="btn btn-primary" style="flex:1" onclick="toggleRSVP()">Start</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-backdrop">
        <div class="modal">
            <h3>Settings</h3>
            <p style="text-align:left; color:var(--text-muted); font-size:0.9rem; margin-bottom:0.5rem;">Select Theme</p>
            <div class="theme-grid">
                <div class="theme-swatch" style="background:#bb86fc;" onclick="setTheme(260)"></div>
                <div class="theme-swatch" style="background:#00e676;" onclick="setTheme(145)"></div>
                <div class="theme-swatch" style="background:#2979ff;" onclick="setTheme(220)"></div>
                <div class="theme-swatch" style="background:#9e9e9e;" onclick="setTheme(0)"></div>
            </div>
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 1.5rem 0;">
            <button class="btn btn-outline" style="width:100%; margin-bottom:10px;" onclick="resetData()">
                <i class="fa-solid fa-trash"></i> Reset Data
            </button>
            <button class="btn btn-primary" style="width:100%;" onclick="closeSettings()">Close</button>
        </div>
    </div>

    <div id="results-modal" class="modal-backdrop">
        <div class="modal">
            <h2><i class="fa-solid fa-trophy" style="color: gold;"></i> Great Job!</h2>
            <div class="stat-grid">
                <div class="stat-box">
                    <span class="stat-num" id="res-wpm">0</span>
                    <span class="stat-label">WPM</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="res-acc">0%</span>
                    <span class="stat-label">Accuracy</span>
                </div>
            </div>
            <p id="motivational-text" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">
                Consistency is the key to mastery.
            </p>
            <button class="btn btn-primary" style="width:100%; margin-bottom: 10px;" onclick="shareResult()">
                <i class="fa-solid fa-share-nodes"></i> Share Result
            </button>
            <button class="btn btn-outline" style="width:100%;" onclick="closeResults()">Close</button>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const DB_KEY = 'voiceflow_data';
        let state = {
            themeHue: 260,
            history: [],
            wpm: 300
        };

        // Random Scripts
        const SCRIPTS = [
            "The quick brown fox jumps over the lazy dog. This sentence contains every letter in the English language and is often used for typing practice.",
            "Success is not final, failure is not fatal: it is the courage to continue that counts. Winston Churchill said this to remind us that resilience is key.",
            "In the middle of difficulty lies opportunity. Do not let obstacles stop you. Instead, let them be the stepping stones to your future success.",
            "Technology is best when it brings people together. We are building the future, one line of code at a time.",
            "To be, or not to be, that is the question: Whether 'tis nobler in the mind to suffer The slings and arrows of outrageous fortune, Or to take arms against a sea of troubles."
        ];

        // Runtime Variables
        let words = [];
        let speechRecognition;
        let isListening = false;
        let rsvpInterval;
        let rsvpIndex = 0;
        let rsvpRunning = false;
        let sessionStartTime;
        let speechCorrectCount = 0;
        let speechCurrentIndex = 0;

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            setTheme(state.themeHue);
            // Check browser support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Note: This browser doesn't support Speech Recognition. Please use Chrome or Edge for the Speech Coach feature.");
            }
        });

        function loadData() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) state = { ...state, ...JSON.parse(saved) };
            document.getElementById('wpm-slider').value = state.wpm;
            updateWPMDisplay(state.wpm);
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
        }

        function resetData() {
            if(confirm("Delete all saved history and settings?")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        // --- THEME ---
        function setTheme(hue) {
            state.themeHue = hue;
            document.documentElement.style.setProperty('--hue', hue);
            // Update monochrome specifically
            if (hue === 0) {
                document.documentElement.style.setProperty('--primary', '#ffffff');
                document.documentElement.style.setProperty('--primary-dim', '#333');
            } else {
                document.documentElement.style.setProperty('--primary', `hsl(${hue}, 80%, 65%)`);
                document.documentElement.style.setProperty('--primary-dim', `hsl(${hue}, 40%, 30%)`);
            }
            // Add visual selection state in modal
            document.querySelectorAll('.theme-swatch').forEach(el => el.classList.remove('selected'));
            // (Simple hack to highlight the clicked one would require event mapping, skipping for brevity)
            saveData();
        }

        function openSettings() { document.getElementById('settings-modal').classList.add('open'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('open'); }

        // --- EDITOR FUNCTIONS ---
        function insertRandomText() {
            const txt = SCRIPTS[Math.floor(Math.random() * SCRIPTS.length)];
            document.getElementById('input-text').value = txt;
        }

        function getCleanWords() {
            const raw = document.getElementById('input-text').value;
            if (!raw.trim()) return [];
            // Preserve basic punctuation for display, strip for logic
            return raw.trim().split(/\s+/);
        }

        // --- SPEECH MODE (The "Killer" Feature) ---
        function initSpeechMode() {
            words = getCleanWords();
            if (words.length === 0) return alert("Please enter text first!");

            // Render Text
            const container = document.getElementById('teleprompter');
            container.innerHTML = words.map((w, i) => `<span id="w-${i}" class="word pending">${w}</span>`).join('');
            
            document.getElementById('speech-overlay').classList.add('active');
            
            speechCurrentIndex = 0;
            speechCorrectCount = 0;
            sessionStartTime = Date.now();
            startRecognition();
        }

        function startRecognition() {
            if (isListening) return;
            
            const SpeechSDK = window.webkitSpeechRecognition || window.SpeechRecognition;
            speechRecognition = new SpeechSDK();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';

            speechRecognition.onstart = () => {
                isListening = true;
                document.getElementById('speech-status').innerText = "Listening...";
                highlightWord(0, 'active');
            };

            speechRecognition.onerror = (e) => {
                console.error(e);
                document.getElementById('speech-status').innerText = "Error (Check Mic)";
            };

            speechRecognition.onend = () => {
                if (isListening) speechRecognition.start(); // Auto-restart
            };

            speechRecognition.onresult = processSpeechResult;
            speechRecognition.start();
        }

        function processSpeechResult(event) {
            // Get latest transcript
            const results = event.results;
            const transcript = results[results.length - 1][0].transcript.toLowerCase().trim();
            const spokenWords = transcript.split(' ');
            const latestWord = spokenWords[spokenWords.length - 1]; // Simply grab the last heard word

            // "Sliding Window" Logic to allow skipping words
            // Check if the spoken word matches the current target OR the next 3 words
            const lookAhead = 4;
            let matchFoundIndex = -1;

            for (let i = 0; i < lookAhead; i++) {
                const checkIndex = speechCurrentIndex + i;
                if (checkIndex >= words.length) break;
                
                // Compare cleaned strings
                const target = words[checkIndex].toLowerCase().replace(/[^\w]/g, "");
                const spoken = latestWord.replace(/[^\w]/g, "");

                if (target && spoken && target === spoken) {
                    matchFoundIndex = checkIndex;
                    break;
                }
            }

            if (matchFoundIndex !== -1) {
                // If we skipped words, mark them as missed
                for (let j = speechCurrentIndex; j < matchFoundIndex; j++) {
                    highlightWord(j, 'missed');
                }
                
                // Mark correct word
                highlightWord(matchFoundIndex, 'spoken');
                speechCorrectCount++;
                
                // Advance
                speechCurrentIndex = matchFoundIndex + 1;
                
                // Highlight next target
                if (speechCurrentIndex < words.length) {
                    highlightWord(speechCurrentIndex, 'active');
                    // Scroll into view
                    const el = document.getElementById(`w-${speechCurrentIndex}`);
                    el.scrollIntoView({behavior: "smooth", block: "center"});
                } else {
                    exitSpeechMode(true); // Finished!
                }
            }
        }

        function highlightWord(index, className) {
            const el = document.getElementById(`w-${index}`);
            if (el) {
                el.className = `word ${className}`;
            }
        }

        function exitSpeechMode(completed = false) {
            isListening = false;
            if (speechRecognition) speechRecognition.stop();
            document.getElementById('speech-overlay').classList.remove('active');

            if (completed || speechCurrentIndex > 2) {
                showResults('Speech');
            }
        }

        // --- RSVP MODE ---
        function initRSVPMode() {
            words = getCleanWords();
            if (words.length === 0) return alert("Please enter text first!");
            
            document.getElementById('rsvp-overlay').classList.add('active');
            document.getElementById('rsvp-word-display').innerText = "Ready";
            document.getElementById('rsvp-toggle-btn').innerText = "Start";
            document.getElementById('rsvp-progress').style.width = '0%';
            rsvpIndex = 0;
            rsvpRunning = false;
        }

        function updateWPMDisplay(val) {
            state.wpm = val;
            document.getElementById('wpm-value').innerText = val + " WPM";
            saveData();
            // If running, restart to update speed
            if (rsvpRunning) {
                clearInterval(rsvpInterval);
                runRSVPLoop();
            }
        }

        function toggleRSVP() {
            if (rsvpRunning) {
                pauseRSVP();
            } else {
                if (rsvpIndex >= words.length) rsvpIndex = 0;
                rsvpRunning = true;
                document.getElementById('rsvp-toggle-btn').innerText = "Pause";
                sessionStartTime = Date.now();
                runRSVPLoop();
            }
        }

        function runRSVPLoop() {
            const delay = 60000 / state.wpm;
            rsvpInterval = setInterval(() => {
                if (rsvpIndex >= words.length) {
                    pauseRSVP();
                    showResults('RSVP');
                    return;
                }
                
                const word = words[rsvpIndex];
                // Highlight middle letter logic for better reading (optional, kept simple here)
                document.getElementById('rsvp-word-display').innerHTML = word;
                
                // Update Progress
                const pct = ((rsvpIndex + 1) / words.length) * 100;
                document.getElementById('rsvp-progress').style.width = pct + '%';

                rsvpIndex++;
            }, delay);
        }

        function pauseRSVP() {
            rsvpRunning = false;
            clearInterval(rsvpInterval);
            document.getElementById('rsvp-toggle-btn').innerText = "Resume";
        }

        function exitRSVPMode() {
            pauseRSVP();
            document.getElementById('rsvp-overlay').classList.remove('active');
        }

        // --- RESULTS & SHARING ---
        function showResults(mode) {
            const timeSec = (Date.now() - sessionStartTime) / 1000;
            const timeMin = timeSec / 60;
            
            let wpm = 0;
            let acc = 100;

            if (mode === 'Speech') {
                wpm = Math.round(speechCurrentIndex / timeMin);
                acc = Math.round((speechCorrectCount / speechCurrentIndex) * 100) || 0;
            } else {
                wpm = state.wpm; // RSVP is fixed speed
                acc = 100; // Assumed 100 for reading
            }

            document.getElementById('res-wpm').innerText = isFinite(wpm) ? wpm : 0;
            document.getElementById('res-acc').innerText = acc + "%";
            
            // Random motivation
            const motives = [
                "You're getting faster every day!",
                "Amazing focus!",
                "Keep pushing your limits!",
                "Speed + Comprehension = Power."
            ];
            document.getElementById('motivational-text').innerText = motives[Math.floor(Math.random()*motives.length)];

            document.getElementById('results-modal').classList.add('open');
        }

        function closeResults() {
            document.getElementById('results-modal').classList.remove('open');
        }

        function shareResult() {
            const wpm = document.getElementById('res-wpm').innerText;
            const text = `I just hit ${wpm} WPM on VoiceFlow! ðŸš€ Improving my speech and reading skills.`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'VoiceFlow Result',
                    text: text,
                    url: window.location.href
                }).catch(console.error);
            } else {
                // Fallback for desktop
                navigator.clipboard.writeText(text);
                alert("Result copied to clipboard!");
            }
        }

    </script>
</body>
</html>
