<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FluencyFlow - Speech & Reading Coach</title>
    <style>
        /* --- THEMES --- */
        :root {
            /* Default (Purple/Cyberpunk) */
            --bg-color: #0f111a;
            --surface-color: #1a1d2d;
            --primary-color: #bb86fc;
            --secondary-color: #03dac6;
            --text-color: #e0e0e0;
            --dim-text: #6b7280;
            --error-color: #cf6679;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* Theme Classes applied to body */
        body.theme-ocean { --bg-color: #0f172a; --surface-color: #1e293b; --primary-color: #38bdf8; --secondary-color: #34d399; }
        body.theme-sunset { --bg-color: #271313; --surface-color: #451a1a; --primary-color: #fbbf24; --secondary-color: #f87171; }
        body.theme-forest { --bg-color: #052e16; --surface-color: #14532d; --primary-color: #4ade80; --secondary-color: #a3e635; }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- LAYOUT & HEADER --- */
        header {
            background-color: var(--surface-color);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }

        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .header-controls { display: flex; gap: 10px; }

        /* --- BUTTONS & INPUTS --- */
        button {
            background: var(--surface-color);
            color: var(--text-color);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        button:hover { background: rgba(255,255,255,0.05); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        
        button.primary {
            background: var(--primary-color);
            color: var(--bg-color);
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        button.primary:hover { filter: brightness(1.1); }
        button.secondary { border-color: var(--secondary-color); color: var(--secondary-color); }
        
        button.icon-btn { padding: 0.5rem; font-size: 1.2rem; }

        /* --- MAIN EDITOR --- */
        main { flex: 1; display: flex; flex-direction: column; position: relative; }

        #editor-container {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        textarea {
            width: 100%;
            flex: 1;
            background-color: rgba(0,0,0,0.2);
            border: 2px solid transparent;
            color: var(--text-color);
            padding: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.6;
            resize: none;
            border-radius: 12px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        textarea:focus { border-color: var(--primary-color); }

        /* --- MODES (OVERLAYS) --- */
        .fullscreen-mode {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .fullscreen-mode.active { transform: translateY(0); }

        /* --- SPEECH COACH VIEW --- */
        #speech-display {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 10%;
            font-size: 2rem;
            line-height: 1.8;
            text-align: left;
            scroll-behavior: smooth;
        }
        
        @media (max-width: 768px) { #speech-display { font-size: 1.5rem; padding: 1rem 5%; } }

        .word { 
            display: inline-block; margin-right: 0.2em; padding: 2px 4px; border-radius: 4px; 
            color: var(--dim-text); transition: all 0.2s; 
        }
        .word.current { color: #fff; text-decoration: underline; text-decoration-color: var(--primary-color); text-underline-offset: 4px; }
        .word.correct { color: var(--bg-color); background-color: var(--secondary-color); }
        .word.missed { color: var(--error-color); text-decoration: line-through; opacity: 0.7; }

        /* --- RSVP SPEED READER VIEW --- */
        #rsvp-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #rsvp-word { font-size: 5rem; font-weight: 800; color: var(--primary-color); text-align: center; }
        
        .rsvp-progress-bar {
            width: 100%; height: 6px; background: rgba(255,255,255,0.1);
            position: absolute; bottom: 0; left: 0;
        }
        .rsvp-progress-fill { height: 100%; background: var(--secondary-color); width: 0%; transition: width 0.1s linear; }

        /* --- STATS DASHBOARD (MODAL) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .modal-card {
            background: var(--surface-color);
            width: 90%; max-width: 500px;
            padding: 2rem; border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
        .stat-box { background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--primary-color); display: block; }
        .stat-lbl { font-size: 0.8rem; text-transform: uppercase; color: var(--dim-text); letter-spacing: 1px; }

        /* --- SETTINGS DRAWER --- */
        .settings-drawer {
            position: fixed; top: 0; right: 0; width: 300px; height: 100%;
            background: var(--surface-color); z-index: 300;
            padding: 2rem; box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            transform: translateX(100%); transition: transform 0.3s;
        }
        .settings-drawer.open { transform: translateX(0); }
        .theme-btn { width: 100%; margin-bottom: 0.5rem; text-align: left; }
        
        /* Utils */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

    </style>
</head>
<body class="theme-default">

    <header>
        <div class="logo">FluencyFlow</div>
        <div class="header-controls">
            <button class="icon-btn" onclick="toggleSettings()" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>

    <main>
        <div id="editor-container">
            <div class="toolbar">
                <div>
                    <button class="primary" onclick="startSpeechMode()">üé§ Speak</button>
                    <button class="secondary" onclick="startRSVP()">‚ö° Speed Read</button>
                </div>
                <button onclick="generateRandomText()">üé≤ Random Script</button>
            </div>
            <textarea id="input-text" placeholder="Paste your speech, article, or study notes here... or click 'Random Script' to get started."></textarea>
        </div>
    </main>

    <div id="speech-mode" class="fullscreen-mode">
        <header>
            <button onclick="exitSpeechMode()">‚Üê Back</button>
            <div id="speech-status" style="color: var(--secondary-color); font-weight:bold;">‚óè Listening</div>
            <button class="primary" onclick="finishSpeechSession()">Finish</button>
        </header>
        <div id="speech-display"></div>
    </div>

    <div id="rsvp-mode" class="fullscreen-mode">
        <header>
            <button onclick="exitRSVPMode()">‚Üê Exit</button>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="rsvp-wpm-display" style="font-size: 0.9rem; color: var(--dim-text)">300 WPM</span>
                <input type="range" id="rsvp-slider" min="100" max="1000" step="50" value="300" oninput="updateRSVPSpeed(this.value)">
            </div>
        </header>
        <div id="rsvp-container" onclick="toggleRSVPPause()">
            <div id="rsvp-word">Ready?</div>
            <div style="margin-top: 1rem; color: var(--dim-text); font-size: 0.9rem;">(Tap to Pause/Resume)</div>
            <div class="rsvp-progress-bar"><div class="rsvp-progress-fill" id="rsvp-fill"></div></div>
        </div>
    </div>

    <div id="results-modal" class="modal-overlay">
        <div class="modal-card">
            <h2 id="result-title">Session Complete!</h2>
            <div class="stat-grid">
                <div class="stat-box">
                    <span class="stat-val" id="res-wpm">0</span>
                    <span class="stat-lbl">WPM</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val" id="res-acc">0%</span>
                    <span class="stat-lbl">Accuracy / Progress</span>
                </div>
            </div>
            <p id="motivational-msg" style="color: var(--dim-text); font-style: italic;">"Great work! Consistency is key."</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 1.5rem;">
                <button class="primary" onclick="shareResult()">üì§ Share</button>
                <button onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="settings-drawer" class="settings-drawer">
        <h3>Settings</h3>
        <p style="color:var(--dim-text); font-size:0.9rem; margin-bottom: 1rem;">Customize your experience.</p>
        
        <h4>Themes</h4>
        <button class="theme-btn" onclick="setTheme('theme-default')">üü£ Cyberpunk (Default)</button>
        <button class="theme-btn" onclick="setTheme('theme-ocean')">üîµ Ocean Depth</button>
        <button class="theme-btn" onclick="setTheme('theme-sunset')">üü† Sunset Glow</button>
        <button class="theme-btn" onclick="setTheme('theme-forest')">üü¢ Forest Zen</button>

        <h4 style="margin-top: 2rem;">Data</h4>
        <button onclick="clearData()" style="width:100%; border-color: var(--error-color); color: var(--error-color);">üóëÔ∏è Clear History</button>
        <button onclick="toggleSettings()" style="margin-top: 2rem; width: 100%;">Close Settings</button>
    </div>

    <script>
        // --- DATA & CONTENT ---
        const sampleTexts = [
            "Success is not final, failure is not fatal: it is the courage to continue that counts. Winston Churchill.",
            "The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet.",
            "To be, or not to be, that is the question: Whether 'tis nobler in the mind to suffer The slings and arrows of outrageous fortune, Or to take arms against a sea of troubles.",
            "I have a dream that one day this nation will rise up and live out the true meaning of its creed: We hold these truths to be self-evident, that all men are created equal.",
            "Peter Piper picked a peck of pickled peppers. A peck of pickled peppers Peter Piper picked. If Peter Piper picked a peck of pickled peppers, where's the peck of pickled peppers Peter Piper picked?"
        ];

        const motivations = [
            "You're on fire! üî•", "Keep pushing limits! üöÄ", "Fluency is a journey. üåä", "Speed reader in the making! ‚ö°"
        ];

        // --- STATE ---
        let state = {
            words: [],
            cleanWords: [],
            currIndex: 0,
            startTime: 0,
            correctCount: 0,
            recognition: null,
            isListening: false,
            rsvpInterval: null,
            rsvpWPM: 300,
            rsvpPaused: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            input: document.getElementById('input-text'),
            speechMode: document.getElementById('speech-mode'),
            rsvpMode: document.getElementById('rsvp-mode'),
            speechDisplay: document.getElementById('speech-display'),
            speechStatus: document.getElementById('speech-status'),
            rsvpWord: document.getElementById('rsvp-word'),
            rsvpFill: document.getElementById('rsvp-fill'),
            rsvpSlider: document.getElementById('rsvp-slider'),
            modal: document.getElementById('results-modal'),
            settings: document.getElementById('settings-drawer'),
            // Results
            resWpm: document.getElementById('res-wpm'),
            resAcc: document.getElementById('res-acc'),
            resTitle: document.getElementById('result-title'),
            resMsg: document.getElementById('motivational-msg')
        };

        // --- CORE FUNCTIONS ---

        function generateRandomText() {
            const random = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
            els.input.value = random;
        }

        function prepareText() {
            let text = els.input.value.trim();
            if (!text) {
                generateRandomText(); // Auto-fill if empty
                text = els.input.value;
            }
            state.words = text.split(/\s+/);
            state.cleanWords = state.words.map(w => w.toLowerCase().replace(/[^\w]/g, ''));
            return state.words.length > 0;
        }

        // --- SPEECH MODE ---

        function startSpeechMode() {
            if (!prepareText()) return;
            
            // API Check
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("Speech API not supported in this browser. Try Chrome.");

            // Reset UI
            els.speechDisplay.innerHTML = state.words.map((w, i) => `<span id="w-${i}" class="word">${w}</span>`).join(' ');
            state.currIndex = 0;
            state.correctCount = 0;
            state.startTime = Date.now();
            els.speechMode.classList.add('active');
            
            // Highlight first
            document.getElementById('w-0').classList.add('current');

            // Init Speech
            state.recognition = new SpeechRecognition();
            state.recognition.continuous = true;
            state.recognition.interimResults = true;
            state.recognition.lang = 'en-US';

            state.recognition.onstart = () => {
                state.isListening = true;
                els.speechStatus.innerText = "‚óè Listening...";
                els.speechStatus.style.color = "var(--secondary-color)";
            };

            state.recognition.onerror = (e) => {
                console.error(e);
                els.speechStatus.innerText = "Error: " + e.error;
                els.speechStatus.style.color = "var(--error-color)";
            };

            state.recognition.onend = () => {
                if (state.isListening) state.recognition.start(); // Auto-restart
            };

            state.recognition.onresult = processSpeech;
            state.recognition.start();
        }

        function processSpeech(event) {
            // Get last chunk of transcript
            const results = event.results;
            const latest = results[results.length - 1][0].transcript.toLowerCase().trim();
            const spokenWords = latest.split(' ');
            
            // Look at the most recently spoken word
            const lastSpoken = spokenWords[spokenWords.length - 1];

            // Search Window (Next 10 words)
            const searchLimit = Math.min(state.currIndex + 10, state.cleanWords.length);
            
            for (let i = state.currIndex; i < searchLimit; i++) {
                // If match found
                if (state.cleanWords[i] === lastSpoken.replace(/[^\w]/g, '')) {
                    
                    // Mark skipped words
                    for (let j = state.currIndex; j < i; j++) {
                        const el = document.getElementById(`w-${j}`);
                        el.className = "word missed";
                    }

                    // Mark correct word
                    const el = document.getElementById(`w-${i}`);
                    el.className = "word correct";
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    state.currIndex = i + 1;
                    state.correctCount++;

                    // Highlight next
                    if (state.currIndex < state.words.length) {
                        document.getElementById(`w-${state.currIndex}`).classList.add('current');
                    } else {
                        finishSpeechSession();
                    }
                    return;
                }
            }
        }

        function finishSpeechSession() {
            if (!state.isListening) return;
            exitSpeechMode(false); // Don't close UI yet

            // Stats
            const timeMin = (Date.now() - state.startTime) / 60000;
            const wpm = Math.round(state.currIndex / (timeMin || 0.01));
            const acc = Math.round((state.correctCount / (state.currIndex || 1)) * 100);

            showResults("Speech Analysis", wpm, acc + "% Accuracy");
        }

        function exitSpeechMode(closeUI = true) {
            state.isListening = false;
            if (state.recognition) state.recognition.stop();
            if (closeUI) els.speechMode.classList.remove('active');
        }

        // --- RSVP MODE ---

        function startRSVP() {
            if (!prepareText()) return;
            els.rsvpMode.classList.add('active');
            state.rsvpPaused = false;
            state.currIndex = 0;
            state.startTime = Date.now(); // Reset time
            runRSVPLoop();
        }

        function runRSVPLoop() {
            if (state.rsvpInterval) clearInterval(state.rsvpInterval);
            
            const delay = 60000 / state.rsvpWPM;
            
            state.rsvpInterval = setInterval(() => {
                if (state.rsvpPaused) return;

                if (state.currIndex >= state.words.length) {
                    finishRSVPSession();
                    return;
                }

                els.rsvpWord.innerText = state.words[state.currIndex];
                
                // Progress Bar
                const pct = ((state.currIndex + 1) / state.words.length) * 100;
                els.rsvpFill.style.width = pct + "%";

                state.currIndex++;
            }, delay);
        }

        function toggleRSVPPause() {
            state.rsvpPaused = !state.rsvpPaused;
            els.rsvpWord.innerText = state.rsvpPaused ? "PAUSED" : state.words[state.currIndex - 1] || "Ready";
            els.rsvpWord.style.opacity = state.rsvpPaused ? "0.5" : "1";
        }

        function updateRSVPSpeed(val) {
            state.rsvpWPM = val;
            document.getElementById('rsvp-wpm-display').innerText = val + " WPM";
            if (!state.rsvpPaused && state.rsvpInterval) runRSVPLoop(); // Update speed live
        }

        function finishRSVPSession() {
            clearInterval(state.rsvpInterval);
            const timeMin = (Date.now() - state.startTime) / 60000; // Not exact due to pauses, but approx
            // For RSVP, WPM is the setting, so we confirm it.
            showResults("Speed Read Complete", state.rsvpWPM, "100% Completed");
            exitRSVPMode(false);
        }

        function exitRSVPMode(closeUI = true) {
            clearInterval(state.rsvpInterval);
            if (closeUI) els.rsvpMode.classList.remove('active');
        }

        // --- RESULTS & UTILS ---

        function showResults(title, wpm, subStat) {
            els.resTitle.innerText = title;
            els.resWpm.innerText = wpm;
            els.resAcc.innerText = subStat;
            els.resMsg.innerText = motivations[Math.floor(Math.random() * motivations.length)];
            els.modal.classList.add('active');

            // Save History
            const history = JSON.parse(localStorage.getItem('fluency_history') || '[]');
            history.push({ date: new Date().toLocaleDateString(), wpm: wpm, type: title });
            localStorage.setItem('fluency_history', JSON.stringify(history));
        }

        function closeModal() {
            els.modal.classList.remove('active');
            // If we came from a mode, ensure we close that mode visually
            els.speechMode.classList.remove('active');
            els.rsvpMode.classList.remove('active');
        }

        function shareResult() {
            const text = `I just hit ${els.resWpm.innerText} WPM on FluencyFlow! üöÄ #SpeedReading #PublicSpeaking`;
            if (navigator.share) {
                navigator.share({ title: 'FluencyFlow Stats', text: text });
            } else {
                navigator.clipboard.writeText(text);
                alert("Stats copied to clipboard!");
            }
        }

        // --- SETTINGS ---
        function toggleSettings() {
            els.settings.classList.toggle('open');
        }

        function setTheme(themeName) {
            document.body.className = themeName;
            localStorage.setItem('fluency_theme', themeName);
        }

        function clearData() {
            if(confirm("Delete all saved history?")) {
                localStorage.removeItem('fluency_history');
                alert("History cleared.");
            }
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            const savedTheme = localStorage.getItem('fluency_theme');
            if (savedTheme) document.body.className = savedTheme;
        };

    </script>
</body>
</html>
