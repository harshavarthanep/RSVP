<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceFlow - Speech & Reading Coach</title>
    <meta name="description" content="Master your reading speed and speech fluency.">
    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            /* Default Theme (Purple/Cyber) */
            --hue: 265;
            --bg-color: #0f0f13;
            --surface-color: #1a1a24;
            --surface-hover: #252530;
            --primary-color: hsl(var(--hue), 100%, 65%);
            --primary-glow: hsla(var(--hue), 100%, 65%, 0.3);
            --text-main: #ffffff;
            --text-muted: #8b8b9e;
            --success: #00e676;
            --danger: #ff5252;
            --font-main: 'Inter', system-ui, -apple-system, sans-serif;
            --radius: 16px;
        }

        /* Theme Overrides via JS classes */
        body.theme-ocean { --hue: 200; --bg-color: #081218; --surface-color: #0f1c24; }
        body.theme-sunset { --hue: 16; --bg-color: #1a0f0a; --surface-color: #291812; }
        body.theme-forest { --hue: 150; --bg-color: #0a140d; --surface-color: #112116; }
        body.theme-mono { --hue: 0; --bg-color: #000000; --surface-color: #1a1a1a; --primary-color: #ffffff; --primary-glow: rgba(255,255,255,0.2); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* --- ICONS (SVG) --- */
        .icon { width: 24px; height: 24px; fill: currentColor; }

        /* --- LAYOUT --- */
        header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface-color);
            z-index: 10;
        }

        .brand { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--primary-color); }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-main);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
        }
        .btn-icon:hover { background: var(--surface-hover); }

        main {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* --- VIEWS --- */
        .view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            opacity: 0;
            pointer-events: none;
            overflow-y: auto;
        }

        .view.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: all;
        }

        /* --- EDITOR VIEW --- */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        textarea {
            flex: 1;
            background: var(--surface-color);
            border: 2px solid transparent;
            border-radius: var(--radius);
            padding: 1.5rem;
            color: var(--text-main);
            font-size: 1.1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            font-family: inherit;
        }
        textarea:focus { border-color: var(--primary-color); }

        /* --- BUTTONS --- */
        .btn {
            background: var(--surface-color);
            color: var(--text-main);
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.1s, background 0.2s;
            justify-content: center;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary {
            background: var(--primary-color);
            color: #000; /* Contrast for light primary */
            box-shadow: 0 4px 20px var(--primary-glow);
        }
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* --- SPEECH MODE --- */
        .speech-content {
            font-size: 1.8rem;
            line-height: 1.8;
            padding: 2rem 0;
            max-width: 800px;
            margin: 0 auto;
        }

        .word {
            display: inline-block;
            margin-right: 6px;
            padding: 2px 4px;
            border-radius: 4px;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .word.current { color: var(--text-main); border-bottom: 3px solid var(--primary-color); transform: scale(1.1); }
        .word.correct { color: var(--success); }
        .word.missed { color: var(--danger); text-decoration: line-through; opacity: 0.5; }

        /* --- SPEED READER (RSVP) --- */
        .rsvp-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .rsvp-word {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 2rem;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .rsvp-progress {
            width: 100%;
            height: 6px;
            background: var(--surface-color);
            border-radius: 10px;
            overflow: hidden;
            max-width: 400px;
        }
        .rsvp-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal {
            background: var(--bg-color);
            border: 1px solid var(--surface-hover);
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .modal h2 { margin-top: 0; }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .stat-box {
            background: var(--surface-color);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); display: block; }
        .stat-lbl { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* --- SETTINGS --- */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--surface-color);
        }
        .theme-selector { display: flex; gap: 10px; margin-top: 10px; }
        .theme-dot {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent;
        }
        .theme-dot.selected { border-color: white; transform: scale(1.1); }

        /* Slider */
        input[type="range"] {
            width: 100%;
            accent-color: var(--primary-color);
            height: 4px;
            background: var(--surface-color);
            border-radius: 4px;
            appearance: none;
        }

        /* --- HELPERS --- */
        .hidden { display: none !important; }
        .quote { font-style: italic; color: var(--text-muted); text-align: center; margin-bottom: 1rem; }
    </style>
</head>
<body class="theme-purple">

    <header>
        <div class="brand">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 3.01-2.69 5.42-6 5.42S5 14.01 5 11h2c0 2.21 1.79 4 4 4s4-1.79 4-4h2zM12 21v2"/></svg>
            Voice<span>Flow</span>
        </div>
        <div>
            <button class="btn-icon" onclick="app.toggleSettings()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.08-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </button>
        </div>
    </header>

    <main>
        <section id="view-editor" class="view active">
            <div class="editor-container">
                <div class="toolbar">
                    <button class="btn" style="padding: 8px 12px; font-size: 0.9rem;" onclick="app.loadRandomText()">
                        üé≤ Random Script
                    </button>
                    <button class="btn" style="padding: 8px 12px; font-size: 0.9rem;" onclick="app.clearText()">
                        üóë Clear
                    </button>
                </div>
                <textarea id="input-text" placeholder="Paste your speech, article, or notes here..."></textarea>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="app.startMode('speech')">
                        <svg class="icon" viewBox="0 0 24 24" style="margin-right:8px"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/></svg>
                        Speech Coach
                    </button>
                    <button class="btn btn-primary" style="background: var(--surface-hover); color: white;" onclick="app.startMode('rsvp')">
                        <svg class="icon" viewBox="0 0 24 24" style="margin-right:8px"><path d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"/></svg>
                        Speed Read
                    </button>
                </div>
            </div>
        </section>

        <section id="view-speech" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button class="btn" onclick="app.goHome()">‚Üê Back</button>
                <div id="speech-status" style="color:var(--success); font-weight:bold;">‚óè Listening</div>
            </div>
            <div class="speech-content" id="speech-display"></div>
            <div style="margin-top:auto; padding-top:1rem; text-align:center;">
                <button class="btn btn-primary" style="width:100%" onclick="app.finishSession()">Stop & View Results</button>
            </div>
        </section>

        <section id="view-rsvp" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button class="btn" onclick="app.goHome()">‚Üê Back</button>
                <span id="rsvp-wpm-display" style="font-weight:bold; color:var(--primary-color)">300 WPM</span>
            </div>
            
            <div class="rsvp-container">
                <div class="rsvp-word" id="rsvp-word">Ready</div>
                <div class="rsvp-progress"><div class="rsvp-bar" id="rsvp-bar"></div></div>
            </div>

            <div style="padding: 2rem 0;">
                <input type="range" id="rsvp-speed" min="100" max="1000" step="50" value="300" oninput="app.updateWpm(this.value)">
                <div class="btn-group" style="margin-top:1rem;">
                    <button class="btn" id="rsvp-toggle-btn" onclick="app.toggleRsvp()">‚ñ∂ Start</button>
                    <button class="btn btn-primary" onclick="app.finishSession()">Finish</button>
                </div>
            </div>
        </section>
    </main>

    <div id="modal-results" class="modal-overlay">
        <div class="modal">
            <h2>Session Complete üéâ</h2>
            <p class="quote" id="result-quote">"Excellent work! Consistency is key."</p>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <span class="stat-val" id="res-wpm">0</span>
                    <span class="stat-lbl">WPM</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val" id="res-acc">0%</span>
                    <span class="stat-lbl">Accuracy</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val" id="res-time">0s</span>
                    <span class="stat-lbl">Time</span>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn" onclick="app.shareResult()">üîó Share</button>
                <button class="btn btn-primary" onclick="app.closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 style="margin:0">Settings</h2>
                <button class="btn-icon" onclick="app.toggleSettings()">‚úï</button>
            </div>

            <div class="setting-row">
                <div>
                    <strong>App Theme</strong>
                    <div class="theme-selector" id="theme-options">
                        </div>
                </div>
            </div>

            <div class="setting-row">
                <span>History Log</span>
                <span id="history-count" style="color:var(--text-muted)">0 Sessions</span>
            </div>

            <div class="btn-group" style="margin-top:1rem;">
                <button class="btn" onclick="app.exportData()">‚¨á Export Data</button>
                <label class="btn" style="cursor:pointer">
                    ‚¨Ü Import <input type="file" hidden onchange="app.importData(this)">
                </label>
            </div>
            
            <button class="btn" style="width:100%; margin-top:1rem; color:var(--danger); border:1px solid var(--danger); background:transparent;" onclick="app.resetData()">Reset All Data</button>
        </div>
    </div>

    <script>
        // --- DATA & CONTENT ---
        const RANDOM_TEXTS = [
            "The quick brown fox jumps over the lazy dog. This pangram contains every letter of the English alphabet.",
            "Success is not final, failure is not fatal: it is the courage to continue that counts. - Winston Churchill",
            "To be, or not to be, that is the question: Whether 'tis nobler in the mind to suffer The slings and arrows of outrageous fortune, Or to take arms against a sea of troubles And by opposing end them.",
            "I have a dream that one day this nation will rise up and live out the true meaning of its creed: 'We hold these truths to be self-evident, that all men are created equal.'",
            "Peter Piper picked a peck of pickled peppers. A peck of pickled peppers Peter Piper picked. If Peter Piper picked a peck of pickled peppers, where's the peck of pickled peppers Peter Piper picked?"
        ];

        const MOTIVATION = [
            "You're doing great! üöÄ", "Practice makes progress! üí™", "Keep that momentum going! üî•", "Communication is power! üó£Ô∏è"
        ];

        const THEMES = [
            { id: 'theme-purple', color: '#bb86fc' },
            { id: 'theme-ocean', color: '#03a9f4' },
            { id: 'theme-sunset', color: '#ff7043' },
            { id: 'theme-forest', color: '#00e676' },
            { id: 'theme-mono', color: '#ffffff' }
        ];

        // --- APP LOGIC ---
        class CoachApp {
            constructor() {
                this.db = JSON.parse(localStorage.getItem('voiceflow_db')) || { history: [], theme: 'theme-purple', wpm: 300 };
                this.state = {
                    mode: null, // 'speech' | 'rsvp'
                    words: [],
                    cleanWords: [],
                    idx: 0,
                    startTime: 0,
                    timer: null,
                    isPaused: true,
                    correctCount: 0,
                    recognition: null
                };
                
                this.init();
            }

            init() {
                this.applyTheme(this.db.theme);
                this.renderThemes();
                this.updateHistoryCount();
                
                // Set initial WPM
                document.getElementById('rsvp-speed').value = this.db.wpm;
                document.getElementById('rsvp-wpm-display').innerText = `${this.db.wpm} WPM`;
            }

            // --- NAVIGATION ---
            goHome() {
                this.stopAll();
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById('view-editor').classList.add('active');
            }

            switchView(id) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            }

            // --- EDITOR ACTIONS ---
            loadRandomText() {
                const txt = RANDOM_TEXTS[Math.floor(Math.random() * RANDOM_TEXTS.length)];
                document.getElementById('input-text').value = txt;
            }

            clearText() {
                if(confirm("Clear text?")) document.getElementById('input-text').value = "";
            }

            prepareData() {
                const raw = document.getElementById('input-text').value.trim();
                if(!raw) {
                    this.loadRandomText();
                    return this.prepareData(); // Recursive retry with random text
                }
                this.state.words = raw.split(/\s+/);
                this.state.cleanWords = this.state.words.map(w => w.toLowerCase().replace(/[^\w]/g, ''));
                this.state.idx = 0;
                this.state.correctCount = 0;
                return true;
            }

            startMode(mode) {
                if(!this.prepareData()) return;
                this.state.mode = mode;
                this.state.startTime = Date.now();
                this.state.isPaused = true;

                if (mode === 'speech') this.initSpeechMode();
                else this.initRsvpMode();
            }

            finishSession() {
                this.stopAll();
                const timeSec = (Date.now() - this.state.startTime) / 1000;
                const totalWords = this.state.idx; // Words processed
                
                // Calc stats
                let wpm = Math.round((totalWords / timeSec) * 60) || 0;
                let acc = 100;

                if (this.state.mode === 'speech') {
                    // For speech, only count correctly recognized words for accuracy
                    acc = totalWords > 0 ? Math.round((this.state.correctCount / totalWords) * 100) : 0;
                } else {
                    // For RSVP, accuracy isn't measured, default to 100% completion
                    acc = 100; 
                }

                // Save to DB
                this.db.history.push({
                    date: new Date().toISOString(),
                    mode: this.state.mode,
                    wpm: wpm,
                    acc: acc
                });
                this.saveDb();

                // Show Results
                document.getElementById('res-wpm').innerText = wpm;
                document.getElementById('res-acc').innerText = acc + '%';
                document.getElementById('res-time').innerText = timeSec.toFixed(0) + 's';
                document.getElementById('result-quote').innerText = MOTIVATION[Math.floor(Math.random() * MOTIVATION.length)];
                
                document.getElementById('modal-results').classList.add('active');
            }

            stopAll() {
                clearInterval(this.state.timer);
                if (this.state.recognition) {
                    this.state.recognition.stop();
                    this.state.recognition = null;
                }
                this.state.isPaused = true;
            }

            // --- SPEECH MODE LOGIC ---
            initSpeechMode() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("Speech API not supported in this browser. Please use Chrome.");
                    return;
                }

                this.switchView('view-speech');
                
                // Render Text
                const display = document.getElementById('speech-display');
                display.innerHTML = this.state.words.map((w, i) => `<span id="w-${i}" class="word">${w}</span>`).join(' ');
                
                // Highlight first
                document.getElementById('w-0').classList.add('current');

                // Setup API
                const SpeechReq = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.state.recognition = new SpeechReq();
                this.state.recognition.continuous = true;
                this.state.recognition.interimResults = true;
                this.state.recognition.lang = 'en-US';

                this.state.recognition.onresult = (e) => this.handleVoiceInput(e);
                this.state.recognition.onend = () => {
                    // Auto-restart if we haven't finished manually
                    if (this.state.mode === 'speech' && document.getElementById('view-speech').classList.contains('active')) {
                        try { this.state.recognition.start(); } catch(err){}
                    }
                };
                
                try {
                    this.state.recognition.start();
                } catch(e) {
                    alert("Microphone access blocked or insecure context. Host on HTTPS/Localhost.");
                }
            }

            handleVoiceInput(event) {
                // Get latest result
                const results = event.results;
                const lastResult = results[results.length - 1];
                const spoken = lastResult[0].transcript.toLowerCase().trim().split(' ').pop(); // Get last word spoken

                // Look ahead logic (fuzzy match)
                const currentTarget = this.state.cleanWords[this.state.idx];
                
                if (spoken === currentTarget) {
                    this.markWord(this.state.idx, 'correct');
                    this.state.idx++;
                    this.state.correctCount++;
                    this.advanceCursor();
                } 
            }

            markWord(index, status) {
                const el = document.getElementById(`w-${index}`);
                if(el) {
                    el.className = `word ${status}`;
                    if(status === 'correct') el.scrollIntoView({behavior: "smooth", block: "center"});
                }
            }

            advanceCursor() {
                if(this.state.idx < this.state.words.length) {
                    document.getElementById(`w-${this.state.idx}`).classList.add('current');
                } else {
                    this.finishSession();
                }
            }

            // --- RSVP MODE LOGIC ---
            initRsvpMode() {
                this.switchView('view-rsvp');
                this.state.idx = 0;
                document.getElementById('rsvp-toggle-btn').innerText = "‚ñ∂ Start";
                document.getElementById('rsvp-word').innerText = "Ready?";
                document.getElementById('rsvp-bar').style.width = '0%';
            }

            toggleRsvp() {
                if(!this.state.isPaused) {
                    clearInterval(this.state.timer);
                    this.state.isPaused = true;
                    document.getElementById('rsvp-toggle-btn').innerText = "‚ñ∂ Resume";
                } else {
                    this.state.isPaused = false;
                    document.getElementById('rsvp-toggle-btn').innerText = "‚è∏ Pause";
                    const wpm = parseInt(document.getElementById('rsvp-speed').value);
                    const delay = 60000 / wpm;

                    this.state.timer = setInterval(() => {
                        if(this.state.idx >= this.state.words.length) {
                            this.finishSession();
                            return;
                        }
                        
                        document.getElementById('rsvp-word').innerText = this.state.words[this.state.idx];
                        
                        // Update Progress bar
                        const pct = ((this.state.idx + 1) / this.state.words.length) * 100;
                        document.getElementById('rsvp-bar').style.width = `${pct}%`;

                        this.state.idx++;
                    }, delay);
                }
            }

            updateWpm(val) {
                this.db.wpm = val;
                this.saveDb();
                document.getElementById('rsvp-wpm-display').innerText = `${val} WPM`;
                // If running, restart timer with new speed
                if(!this.state.isPaused) {
                    this.toggleRsvp(); // stop
                    this.toggleRsvp(); // start
                }
            }

            // --- SETTINGS & DATA ---
            toggleSettings() {
                document.getElementById('modal-settings').classList.toggle('active');
            }

            closeModal() {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
                if(this.state.mode) this.goHome(); // Return home after stats
            }

            saveDb() {
                localStorage.setItem('voiceflow_db', JSON.stringify(this.db));
                this.updateHistoryCount();
            }

            updateHistoryCount() {
                document.getElementById('history-count').innerText = `${this.db.history.length} Sessions`;
            }

            renderThemes() {
                const container = document.getElementById('theme-options');
                container.innerHTML = THEMES.map(t => `
                    <div class="theme-dot ${this.db.theme === t.id ? 'selected' : ''}" 
                         style="background:${t.color}" 
                         onclick="app.applyTheme('${t.id}')"></div>
                `).join('');
            }

            applyTheme(themeId) {
                document.body.className = themeId;
                this.db.theme = themeId;
                this.renderThemes();
                this.saveDb();
            }

            resetData() {
                if(confirm("Delete all history and reset settings?")) {
                    localStorage.removeItem('voiceflow_db');
                    location.reload();
                }
            }

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.db));
                const anchor = document.createElement('a');
                anchor.setAttribute("href", dataStr);
                anchor.setAttribute("download", "voiceflow_backup.json");
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
            }

            importData(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.db = JSON.parse(e.target.result);
                        this.saveDb();
                        alert("Data imported successfully!");
                        location.reload();
                    } catch(err) {
                        alert("Invalid file format.");
                    }
                };
                reader.readAsText(file);
            }

            shareResult() {
                const text = `I just practiced reading at ${document.getElementById('res-wpm').innerText} WPM with ${document.getElementById('res-acc').innerText} accuracy using VoiceFlow! üöÄ`;
                if(navigator.share) {
                    navigator.share({ title: 'VoiceFlow Result', text: text });
                } else {
                    navigator.clipboard.writeText(text);
                    alert("Result copied to clipboard!");
                }
            }
        }

        // --- INIT ---
        const app = new CoachApp();

    </script>
</body>
</html>
