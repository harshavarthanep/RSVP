<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speech & Reading Coach Pro</title>
    <style>
        /* --- THEMING VARIABLES --- */
        :root {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --surface-hover: #334155;
            --primary-color: #8b5cf6; /* Cyber Purple */
            --primary-hover: #7c3aed;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Theme Classes */
        body.theme-matrix { --primary-color: #00ff41; --primary-hover: #00cc33; --bg-color: #000000; --surface-color: #111111; }
        body.theme-gold { --primary-color: #fbbf24; --primary-hover: #d97706; --bg-color: #1c1917; --surface-color: #292524; }
        body.theme-mono { --primary-color: #ffffff; --primary-hover: #cccccc; --bg-color: #000000; --surface-color: #262626; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-family);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- LAYOUT UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }

        /* --- HEADER --- */
        header {
            padding: 1rem;
            background: var(--surface-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 10;
        }
        
        .logo { font-weight: 800; font-size: 1.25rem; letter-spacing: -0.025em; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--primary-color); }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: var(--surface-hover); color: var(--text-main); }

        /* --- MAIN VIEWS --- */
        main { flex: 1; position: relative; overflow: hidden; }

        /* View: EDITOR */
        #view-editor {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
        }

        textarea {
            flex: 1;
            background: var(--surface-color);
            border: 2px solid transparent;
            border-radius: var(--radius);
            color: var(--text-main);
            padding: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            transition: all 0.2s;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }
        textarea:focus { border-color: var(--primary-color); background: var(--bg-color); }

        .action-bar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* View: COACH (Speech) */
        #view-coach {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
        }

        #teleprompter {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            font-size: 2rem;
            line-height: 1.8;
            max-width: 900px;
            margin: 0 auto;
            text-align: left;
            scroll-behavior: smooth;
        }

        .word {
            display: inline-block;
            margin-right: 0.25em;
            padding: 2px 0;
            border-radius: 4px;
            color: var(--text-dim);
            transition: 0.2s;
        }
        .word.active { color: var(--text-main); text-decoration: underline; text-decoration-color: var(--primary-color); text-underline-offset: 4px; transform: scale(1.05); }
        .word.match { color: var(--bg-color); background: var(--success); padding: 2px 6px; }
        .word.skipped { color: var(--error); text-decoration: line-through; opacity: 0.5; }

        /* View: RSVP (Speed Reader) */
        #view-rsvp {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--surface-color);
        }

        #rsvp-display {
            font-size: 4rem;
            font-weight: 800;
            color: var(--primary-color);
            text-align: center;
            height: 120px; /* Fixed height to prevent jumps */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- CONTROLS --- */
        button {
            border: none;
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 14px 0 rgba(0,0,0,0.3); }
        .btn-primary:hover { opacity: 0.9; }
        
        .btn-secondary { background: var(--surface-hover); color: var(--text-main); }
        .btn-secondary:hover { background: #475569; }

        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--error); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            z-index: 50;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }

        .modal {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%; max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: translateY(20px); transition: transform 0.3s;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.open .modal { transform: translateY(0); }

        h2 { margin-top: 0; color: var(--primary-color); }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
        .stat-box { background: var(--bg-color); padding: 1rem; border-radius: 8px; text-align: center; }
        .stat-val { display: block; font-size: 1.8rem; font-weight: bold; color: var(--text-main); }
        .stat-lbl { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }

        /* Range Slider */
        input[type=range] { width: 100%; accent-color: var(--primary-color); margin: 10px 0; }

        /* --- CONFETTI ANIMATION --- */
        @keyframes pop { 0% { transform: translateY(0) rotate(0); opacity: 1;} 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .confetti { position: fixed; width: 10px; height: 10px; background: #f00; animation: pop 3s ease-out forwards; z-index: 100; pointer-events: none; }

        /* --- RESPONSIVE --- */
        @media (max-width: 600px) {
            #rsvp-display { font-size: 2.5rem; }
            #teleprompter { font-size: 1.4rem; padding: 1rem; }
            .action-bar { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal">
            <div class="flex" style="justify-content: space-between;">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="icon-btn" onclick="toggleModal('settings-modal')">‚úï</button>
            </div>
            
            <p style="margin-bottom: 5px; color: var(--text-dim);">Theme</p>
            <div class="flex gap-2" style="margin-bottom: 20px;">
                <button class="btn-secondary" style="flex:1" onclick="setTheme('default')">üü£</button>
                <button class="btn-secondary" style="flex:1" onclick="setTheme('theme-matrix')">üü¢</button>
                <button class="btn-secondary" style="flex:1" onclick="setTheme('theme-gold')">üü°</button>
                <button class="btn-secondary" style="flex:1" onclick="setTheme('theme-mono')">‚ö´</button>
            </div>

            <p style="margin-bottom: 5px; color: var(--text-dim);">Data Management</p>
            <div class="flex flex-col gap-2">
                <button class="btn-secondary" onclick="exportData()">üíæ Export Data (JSON)</button>
                <button class="btn-secondary" onclick="document.getElementById('import-file').click()">üìÇ Import Data</button>
                <input type="file" id="import-file" style="display:none" onchange="importData(this)">
                <button class="btn-danger" onclick="resetData()">üóëÔ∏è Reset All Data</button>
            </div>
        </div>
    </div>

    <div id="results-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="result-title">Session Complete! üéâ</h2>
            <p id="result-msg" style="color: var(--text-dim); text-align: center;">Great job improving your skills.</p>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <span class="stat-val" id="res-wpm">0</span>
                    <span class="stat-lbl">WPM</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val" id="res-acc">0%</span>
                    <span class="stat-lbl">Accuracy</span>
                </div>
            </div>

            <button class="btn-primary w-full" onclick="shareResult()">üîó Share Achievement</button>
            <button class="btn-secondary w-full" style="margin-top:10px;" onclick="closeResults()">Back to Editor</button>
        </div>
    </div>

    <header>
        <div class="logo">
            <span>‚ö°</span> SpeechCoach
        </div>
        <button class="icon-btn" onclick="toggleModal('settings-modal')">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        </button>
    </header>

    <main>
        <section id="view-editor">
            <div style="flex:1; display:flex; flex-direction:column;">
                <label style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 8px; display:flex; justify-content:space-between;">
                    <span>INPUT TEXT</span>
                    <span id="word-count" style="font-size:0.8rem">0 words</span>
                </label>
                <textarea id="input-text" placeholder="Paste your speech here, or leave empty to generate a random script..."></textarea>
            </div>

            <div class="action-bar">
                <div style="background: var(--surface-color); padding: 1rem; border-radius: var(--radius);">
                    <div style="display:flex; justify-content:space-between; color: var(--text-dim); font-size: 0.8rem;">
                        <span>SPEED READER</span>
                        <span id="rsvp-wpm-val">300 WPM</span>
                    </div>
                    <input type="range" id="rsvp-slider" min="100" max="800" value="300" step="50" oninput="updateSliderVal(this.value)">
                    <button class="btn-primary w-full" onclick="startRSVP()">
                        <span>‚ö° Start Speed Read</span>
                    </button>
                </div>

                <button class="btn-primary w-full" style="height: 100%; font-size: 1.1rem;" onclick="startSpeechCoach()">
                    <span>üé§ Start Speech Coach</span>
                </button>
            </div>
        </section>

        <section id="view-coach" class="hidden">
            <div style="padding: 1rem; border-bottom: 1px solid var(--surface-hover); display:flex; justify-content:space-between; align-items:center;">
                <button class="btn-secondary" style="padding: 0.5rem 1rem;" onclick="stopSpeechCoach()">‚Üê Exit</button>
                <div style="display:flex; align-items:center; gap:10px;">
                    <div id="mic-status" style="width:10px; height:10px; border-radius:50%; background:var(--error);"></div>
                    <span style="font-size: 0.9rem; color: var(--text-dim);">Listening...</span>
                </div>
            </div>
            <div id="teleprompter"></div>
            <div style="padding: 1rem; text-align: center;">
                <button class="btn-primary" onclick="finishSession()">Finish Session</button>
            </div>
        </section>

        <section id="view-rsvp" class="hidden">
            <div id="rsvp-display">Ready</div>
            <div style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="stopRSVP(true)">Stop Reading</button>
            </div>
        </section>
    </main>

    <script>
        // --- CONSTANTS & RANDOM DATA ---
        const RANDOM_SCRIPTS = [
            "Success is not final, failure is not fatal: it is the courage to continue that counts. Whether you're speaking to a crowd or reading alone, every word is a step forward.",
            "The quick brown fox jumps over the lazy dog. Speed reading helps you process information faster by reducing subvocalization and increasing your visual span.",
            "Public speaking is the art of giving power to words‚Äîto influence, inspire, and transform lives. Confidence comes from preparation and practice."
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            mode: 'editor', // editor, coach, rsvp
            words: [],
            cleanWords: [],
            currentIndex: 0,
            startTime: 0,
            correctCount: 0,
            wpm: 300,
            interval: null,
            recognition: null,
            isListening: false
        };

        // --- INIT ---
        window.onload = () => {
            loadSettings();
            document.getElementById('input-text').addEventListener('input', updateWordCount);
        };

        // --- CORE UTILS ---
        function getEl(id) { return document.getElementById(id); }
        function hideAllViews() {
            ['view-editor', 'view-coach', 'view-rsvp'].forEach(id => getEl(id).classList.add('hidden'));
        }
        function showView(id) {
            hideAllViews();
            getEl(id).classList.remove('hidden');
        }

        function updateWordCount() {
            const text = getEl('input-text').value.trim();
            const count = text ? text.split(/\s+/).length : 0;
            getEl('word-count').innerText = `${count} words`;
        }

        function updateSliderVal(val) {
            state.wpm = val;
            getEl('rsvp-wpm-val').innerText = `${val} WPM`;
        }

        function prepareContent() {
            let text = getEl('input-text').value.trim();
            if (!text) {
                text = RANDOM_SCRIPTS[Math.floor(Math.random() * RANDOM_SCRIPTS.length)];
                getEl('input-text').value = text; // Show user what was picked
            }
            state.words = text.split(/\s+/);
            state.cleanWords = state.words.map(w => w.toLowerCase().replace(/[^\w]/g, ''));
            return state.words.length > 0;
        }

        // --- FEATURE: SPEECH COACH ---
        function startSpeechCoach() {
            if (!prepareContent()) return;

            // Browser Check
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Speech recognition is not supported in this browser. Please use Chrome or Edge.");
                return;
            }

            // Setup UI
            const container = getEl('teleprompter');
            container.innerHTML = state.words.map((w, i) => `<span id="w-${i}" class="word">${w}</span>`).join(' ');
            state.currentIndex = 0;
            state.correctCount = 0;
            state.startTime = Date.now();
            
            showView('view-coach');
            highlightWord(0);

            // Setup API
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            state.recognition = new SpeechRecognition();
            state.recognition.continuous = true;
            state.recognition.interimResults = true;
            state.recognition.lang = 'en-US';

            state.recognition.onstart = () => {
                state.isListening = true;
                getEl('mic-status').style.background = 'var(--success)';
            };

            state.recognition.onend = () => {
                if (state.isListening) state.recognition.start(); // Auto-restart
                else getEl('mic-status').style.background = 'var(--error)';
            };

            state.recognition.onresult = handleSpeechInput;
            state.recognition.start();
        }

        function handleSpeechInput(event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                transcript += event.results[i][0].transcript;
            }
            
            const spoken = transcript.toLowerCase().trim().split(/\s+/);
            const lastSpoken = spoken[spoken.length - 1]; // Just check the latest word
            
            // Fuzzy Lookahead (Check next 3 words in case user skipped one)
            for (let i = 0; i < 4; i++) {
                let targetIdx = state.currentIndex + i;
                if (targetIdx >= state.cleanWords.length) break;

                // Check for match
                if (state.cleanWords[targetIdx] === lastSpoken.replace(/[^\w]/g, '')) {
                    // Mark skipped
                    for (let j = state.currentIndex; j < targetIdx; j++) {
                        getEl(`w-${j}`).className = 'word skipped';
                    }
                    
                    // Mark correct
                    const el = getEl(`w-${targetIdx}`);
                    el.className = 'word match';
                    el.scrollIntoView({ behavior: "smooth", block: "center" });

                    state.currentIndex = targetIdx + 1;
                    state.correctCount++;
                    
                    if (state.currentIndex < state.words.length) {
                        highlightWord(state.currentIndex);
                    } else {
                        finishSession();
                    }
                    break;
                }
            }
        }

        function highlightWord(idx) {
            document.querySelectorAll('.word.active').forEach(e => e.classList.remove('active'));
            if(getEl(`w-${idx}`)) getEl(`w-${idx}`).classList.add('active');
        }

        function stopSpeechCoach() {
            state.isListening = false;
            if (state.recognition) state.recognition.stop();
            showView('view-editor');
        }

        function finishSession() {
            state.isListening = false;
            if (state.recognition) state.recognition.stop();
            
            const timeMin = (Date.now() - state.startTime) / 60000;
            const wpm = Math.round(state.currentIndex / (timeMin || 1)); // Avoid infinity
            const acc = Math.round((state.correctCount / (state.currentIndex || 1)) * 100);

            showResults("Speech Session", wpm, acc);
        }

        // --- FEATURE: RSVP READER ---
        function startRSVP() {
            if (!prepareContent()) return;
            showView('view-rsvp');
            
            let idx = 0;
            const delay = 60000 / state.wpm;
            const display = getEl('rsvp-display');
            state.startTime = Date.now();

            // Countdown
            display.innerText = "3";
            setTimeout(() => display.innerText = "2", 500);
            setTimeout(() => display.innerText = "1", 1000);
            
            setTimeout(() => {
                state.interval = setInterval(() => {
                    if (idx >= state.words.length) {
                        stopRSVP(false); // Finished naturally
                        return;
                    }
                    display.innerText = state.words[idx];
                    idx++;
                    state.currentIndex = idx; // Track progress
                }, delay);
            }, 1500);
        }

        function stopRSVP(manualAbort) {
            clearInterval(state.interval);
            
            if (manualAbort && state.currentIndex === 0) {
                showView('view-editor'); // Just exit if barely started
                return;
            }

            const timeMin = (Date.now() - state.startTime) / 60000;
            const wpm = state.wpm; // In RSVP, WPM is fixed
            const acc = 100; // Assumed 100% for reading unless we add eye tracking
            
            // If stopped early, calculate actual words read
            const wordsRead = state.currentIndex;
            
            showResults("Speed Reading", wpm, "N/A", `You read ${wordsRead} words.`);
        }

        // --- RESULTS & GAMIFICATION ---
        function showResults(title, wpm, acc, customMsg) {
            getEl('result-title').innerText = title;
            getEl('res-wpm').innerText = wpm;
            getEl('res-acc').innerText = acc === "N/A" ? "-" : acc + "%";
            getEl('result-msg').innerText = customMsg || getMotivationalQuote(wpm);
            
            toggleModal('results-modal');
            fireConfetti();
            saveHistory(title, wpm, acc);
        }

        function closeResults() {
            toggleModal('results-modal');
            showView('view-editor');
        }

        function getMotivationalQuote(wpm) {
            if (wpm > 200) return "üî• You're on fire! Amazing speed.";
            if (wpm > 130) return "üöÄ Great pace! Keep pushing.";
            return "üå± Good start! Practice makes perfect.";
        }

        function fireConfetti() {
            for(let i=0; i<30; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                conf.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 4000);
            }
        }

        // --- SHARING ---
        function shareResult() {
            const wpm = getEl('res-wpm').innerText;
            const text = `I just hit ${wpm} WPM using SpeechCoach! üöÄ Improve your speaking & reading skills here:`;
            
            if (navigator.share) {
                navigator.share({ title: 'SpeechCoach Result', text: text, url: window.location.href });
            } else {
                navigator.clipboard.writeText(`${text} ${window.location.href}`);
                alert("Result copied to clipboard!");
            }
        }

        // --- STORAGE & SETTINGS ---
        function toggleModal(id) {
            const el = getEl(id);
            if (el.classList.contains('open')) el.classList.remove('open');
            else el.classList.add('open');
        }

        function setTheme(themeName) {
            document.body.className = themeName === 'default' ? '' : themeName;
            localStorage.setItem('speechCoachTheme', themeName);
        }

        function saveHistory(mode, wpm, acc) {
            const history = JSON.parse(localStorage.getItem('speechCoachData') || '[]');
            history.push({ date: new Date().toISOString(), mode, wpm, acc });
            localStorage.setItem('speechCoachData', JSON.stringify(history));
        }

        function loadSettings() {
            const theme = localStorage.getItem('speechCoachTheme');
            if (theme) document.body.className = theme;
        }

        function resetData() {
            if(confirm("Delete all history and settings?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function exportData() {
            const data = localStorage.getItem('speechCoachData') || '[]';
            const blob = new Blob([data], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "speech_coach_data.json";
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    JSON.parse(e.target.result); // Validate JSON
                    localStorage.setItem('speechCoachData', e.target.result);
                    alert("Data imported successfully!");
                } catch (err) {
                    alert("Invalid file format.");
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
